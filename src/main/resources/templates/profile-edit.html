<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>프로필 수정</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        /* 전체 컨테이너 중앙 정렬 */
        .profile-edit-container {
            max-width: 600px;
            margin: 50px auto;
            padding: 30px;
            border-radius: 10px;
            background-color: #f8f9fa;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        /* 프로필 이미지 스타일 */
        .profile-image-preview {
            width: 300px;
            height: 300px;
            border-radius: 10px;
            object-fit: cover;
            display: block;
            margin: 0 auto 20px;
            background-color: #e9ecef;
            cursor: pointer; /* 클릭 가능하게 변경 */
        }

        /* 숨겨진 파일 입력 */
        #profileImage {
            display: none;
        }

        /* 버튼 스타일 */
        .btn-custom {
            width: 100px;
            display: block;
            margin: 0 auto;
        }
    </style>
</head>
<body data-user-id="/*[[${user.uid}]]*/">

    <!-- 헤더 포함 -->
    <div th:replace="~{layout/header :: header}"></div>

    <div class="container">
        <div class="profile-edit-container">
            <h2 class="text-center">프로필 수정</h2>
            
            <!-- 프로필 사진 미리보기 (클릭하면 파일 선택 창 열림) -->
            <img id="profilePreview" th:src="${user.profileImageUrl}" alt="프로필 사진" class="profile-image-preview">
            <input type="file" id="profileImage" name="image" accept="image/*">

            <form id="editProfileForm" enctype="multipart/form-data">
                <div class="mb-3">
                    <label for="username" class="form-label">사용자명</label>
                    <input type="text" class="form-control" id="username" name="username" th:value="${user.username}">
                </div>

                <div class="mb-3">
                    <label for="bio" class="form-label">자기소개</label>
                    <textarea class="form-control" id="bio" name="bio" rows="3" th:text="${user.bio}"></textarea>
                </div>

                <button type="submit" class="btn btn-success btn-custom">완료</button>
            </form>
        </div>
    </div>

    <script>
        // 프로필 사진 클릭 시 파일 선택 창 열기
        document.getElementById("profilePreview").addEventListener("click", function() {
            document.getElementById("profileImage").click();
        });

        // 프로필 사진 미리보기 기능
        document.getElementById("profileImage").addEventListener("change", function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById("profilePreview").src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // 프로필 수정 폼 제출 처리
        document.getElementById("editProfileForm").addEventListener("submit", function(event) {
            event.preventDefault();

            let userId = document.body.dataset.userId; // 사용자 ID 가져오기
            let formData = new FormData(this);

            fetch(`/api/users/${userId}`, {
                method: "PUT",
                body: formData,
                headers: {
                    "Authorization": "Bearer " + localStorage.getItem("token")
                }
            })
            .then(response => {
                if (response.ok) {
                    window.location.href = "/profile"; // 프로필 페이지로 이동
                } else {
                    alert("프로필 업데이트 실패!");
                }
            })
            .catch(error => {
                console.error("프로필 업데이트 중 오류 발생:", error);
                alert("프로필 업데이트 중 오류가 발생했습니다.");
            });
        });
    </script>

    <div th:replace="~{layout/footer :: footer}"></div>
</body>
</html>
